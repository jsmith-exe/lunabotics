<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rock Pi Metrics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e0f12; --card:#151720; --text:#e7e9ee; --muted:#9aa3b2;
      --ok:#58e; --warn:#f7b500; --bad:#ff5d5d; --accent:#7cd992;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      display:flex; flex-direction:column; overflow:hidden;
    }
    header{
      padding:12px 16px; background:#12141a; display:flex; align-items:center; gap:12px;
      border-bottom:1px solid #1d2130;
    }
    h1{font-size:16px; margin:0; font-weight:600}
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; background:#1c2030; color:#b7c0d1}
    #grid{
      padding:16px; display:grid; gap:16px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      grid-auto-rows: 1fr;
      height: calc(100vh - 54px);
    }
    .card{
      background:var(--card); border:1px solid #1f2333; border-radius:16px; padding:16px;
      display:flex; flex-direction:column; justify-content:space-between;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .label{font-size:12px; color:var(--muted); letter-spacing:.4px; text-transform:uppercase}
    .value{font-size:36px; font-weight:700; line-height:1.1; margin-top:8px}
    .sub{font-size:13px; color:var(--muted); margin-top:6px}
    .bar{position:relative; height:12px; background:#0f1220; border-radius:999px; overflow:hidden; margin-top:12px; border:1px solid #222739;}
    .bar > span{position:absolute; left:0; top:0; bottom:0; width:0%;}
    .bar.ok  > span{background:linear-gradient(90deg, #4dd0e1, #58e)}
    .bar.mid > span{background:linear-gradient(90deg, #f7d774, #f7b500)}
    .bar.bad > span{background:linear-gradient(90deg, #ff9d9d, #ff5d5d)}
    .big{font-size:28px}
    .tiny{font-size:12px; color:var(--muted)}
    @media (max-width: 1100px){ #grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 620px){  #grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Rock Pi Metrics</h1>
    <span class="pill" id="status">connecting…</span>
    <span class="pill" id="rate">—</span>
    <span class="pill" id="host">—</span>
    <span class="pill" id="time">—</span>
  </header>

  <section id="grid">
    <div class="card" id="card-cpu">
      <div>
        <div class="label">CPU Load</div>
        <div class="value" id="cpu-val">—%</div>
        <div class="bar ok" id="cpu-bar"><span></span></div>
      </div>
      <div class="sub" id="cpu-sub">—</div>
    </div>

    <div class="card" id="card-mem">
      <div>
        <div class="label">Memory</div>
        <div class="value" id="mem-val">—%</div>
        <div class="bar ok" id="mem-bar"><span></span></div>
      </div>
      <div class="sub" id="mem-sub">—</div>
    </div>

    <div class="card" id="card-temp">
      <div>
        <div class="label">Temperature</div>
        <div class="value" id="temp-val">—°C</div>
      </div>
      <div class="sub" id="temp-sub">—</div>
    </div>

    <div class="card" id="card-net">
      <div>
        <div class="label">Network (kB/s)</div>
        <div class="value big" id="net-val">↓ —   ↑ —</div>
      </div>
      <div class="sub tiny" id="net-sub">—</div>
    </div>
  </section>

  <script>
    const params = new URLSearchParams(location.search);
    const interval = parseInt(params.get('interval') || '1000', 10);
    document.getElementById('rate').textContent = 'every ' + interval + ' ms';

    function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
    function setBar(el,pct){
      const p = clamp(pct,0,100); const span=el.querySelector('span');
      span.style.width=p+'%'; el.classList.remove('ok','mid','bad');
      if(p<50)el.classList.add('ok');else if(p<80)el.classList.add('mid');else el.classList.add('bad');
    }
    function fmtBytes(n){if(n==null)return'—';const u=['B','kB','MB','GB','TB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++;}return n.toFixed(1)+' '+u[i];}
    function fmt(n,d=1){return(n==null||isNaN(n))?'—':Number(n).toFixed(d);}
    const es=new EventSource('/rockpi_metrics/stream?interval='+interval);
    es.addEventListener('metrics',e=>{
      document.getElementById('status').textContent='live';
      const m=JSON.parse(e.data);
      document.getElementById('host').textContent=m.hostname||'—';
      document.getElementById('time').textContent=m.ts||'—';
      const cpu=m.cpu?.percent_total??null;
      document.getElementById('cpu-val').textContent=(cpu==null?'—':Math.round(cpu))+'%';
      setBar(document.getElementById('cpu-bar'),cpu||0);
      const la=m.cpu?.loadavg||{};
      document.getElementById('cpu-sub').textContent='Load avg: '+[la['1m'],la['5m'],la['15m']].map(x=>fmt(x,2)).join(' / ');
      const vm=m.memory?.virtual||{};const memPct=vm.percent??null;
      document.getElementById('mem-val').textContent=(memPct==null?'—':Math.round(memPct))+'%';
      setBar(document.getElementById('mem-bar'),memPct||0);
      document.getElementById('mem-sub').textContent=fmtBytes(vm.used)+' / '+fmtBytes(vm.total);
      let tVal=null,tLabel='';if(m.temps){const keys=Object.keys(m.temps);
        if(keys.length){const first=m.temps[keys[0]];
          if(Array.isArray(first)&&first.length){tVal=first[0].current;tLabel=first[0].label||keys[0];}
          else if(Array.isArray(m.temps.thermal_zones)&&m.temps.thermal_zones.length){tVal=m.temps.thermal_zones[0].current;tLabel=m.temps.thermal_zones[0].zone;}
        }}
      document.getElementById('temp-val').textContent=(tVal==null?'—':fmt(tVal,1)+'°C');
      document.getElementById('temp-sub').textContent=tLabel||'—';
      const rx=m.net?.rate_rx_kBps??null;const tx=m.net?.rate_tx_kBps??null;
      document.getElementById('net-val').textContent='↓ '+fmt(rx,1)+'   ↑ '+fmt(tx,1);
      const io=m.net?.io||{};
      document.getElementById('net-sub').textContent='Total: ↓ '+fmtBytes(io.bytes_recv)+' / ↑ '+fmtBytes(io.bytes_sent);
    });
    es.onopen=()=>document.getElementById('status').textContent='connected';
    es.onerror=()=>document.getElementById('status').textContent='reconnecting…';
  </script>
</body>
</html>
